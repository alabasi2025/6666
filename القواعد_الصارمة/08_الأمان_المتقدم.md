# 🔴 قواعد الأمان المتقدم (Advanced Security)

> **الفئة:** الأمان المتقدم  
> **عدد القواعد:** 4 قواعد  
> **مستوى الأهمية:** حرج

---

## القاعدة 24: التحقق من المدخلات (Input Validation Rule)

> **كل مدخل من المستخدم يجب التحقق منه باستخدام Zod أو مكتبة مشابهة.**

**المبدأ الأساسي:**
> "لا تثق بأي مدخل من المستخدم. تحقق من كل شيء."

**مثال على التحقق الصحيح:**
```typescript
import { z } from 'zod';

// تعريف Schema للتحقق
const createUserSchema = z.object({
  name: z.string()
    .min(2, 'الاسم قصير جداً')
    .max(100, 'الاسم طويل جداً'),
  email: z.string()
    .email('البريد الإلكتروني غير صالح'),
  age: z.number()
    .min(18, 'يجب أن يكون العمر 18 أو أكثر')
    .max(120, 'العمر غير صالح'),
  password: z.string()
    .min(8, 'كلمة المرور قصيرة')
    .regex(/[A-Z]/, 'يجب أن تحتوي على حرف كبير')
    .regex(/[0-9]/, 'يجب أن تحتوي على رقم')
});

// استخدام في الـ Route
app.post('/users', async (req, res) => {
  const result = createUserSchema.safeParse(req.body);
  if (!result.success) {
    return res.status(400).json({ errors: result.error.errors });
  }
  // المدخلات آمنة الآن
  const user = await createUser(result.data);
});
```

**قائمة التحقق:**
- [ ] جميع المدخلات لها Schema
- [ ] الأنواع محددة (string, number, etc.)
- [ ] الحدود محددة (min, max)
- [ ] الأنماط محددة (email, url, regex)
- [ ] الرسائل بالعربية واضحة

**العقوبة:** رفض الدمج - لا يُقبل أي endpoint بدون validation.

---

## القاعدة 25: سجلات التدقيق (Audit Logs Rule)

> **يجب تسجيل جميع العمليات الحساسة: من فعل، متى، ماذا فعل، على ماذا.**

**العمليات التي يجب تسجيلها:**

| العملية | مستوى الأهمية |
|:---|:---:|
| تسجيل الدخول/الخروج | 🔴 حرج |
| تغيير كلمة المرور | 🔴 حرج |
| إضافة/حذف مستخدم | 🔴 حرج |
| تعديل الصلاحيات | 🔴 حرج |
| حذف بيانات | 🟡 مهم |
| تعديل إعدادات | 🟡 مهم |
| تصدير بيانات | 🟡 مهم |
| عمليات مالية | 🔴 حرج |

**هيكل سجل التدقيق:**
```typescript
interface AuditLog {
  id: string;
  timestamp: Date;
  userId: string;
  userName: string;
  action: string;        // 'CREATE' | 'UPDATE' | 'DELETE' | 'LOGIN' | 'EXPORT'
  resource: string;      // 'user' | 'order' | 'settings'
  resourceId: string;
  oldValue?: object;     // القيمة القديمة (للتعديل)
  newValue?: object;     // القيمة الجديدة
  ipAddress: string;
  userAgent: string;
  status: 'success' | 'failure';
  errorMessage?: string;
}

// مثال على التسجيل
await auditLog.create({
  userId: currentUser.id,
  userName: currentUser.name,
  action: 'DELETE',
  resource: 'user',
  resourceId: deletedUserId,
  oldValue: deletedUserData,
  ipAddress: req.ip,
  userAgent: req.headers['user-agent'],
  status: 'success'
});
```

**العقوبة:** رفض الدمج - العمليات الحساسة بدون تسجيل تُرفض.

---

## القاعدة 26: عدم كشف الأخطاء الداخلية (Error Masking Rule)

> **الأخطاء التقنية الداخلية يجب ألا تظهر للمستخدم النهائي.**

**المبدأ الأساسي:**
> "المستخدم يرى رسالة ودية، المطور يرى التفاصيل في السجلات."

**مثال على معالجة الأخطاء:**
```typescript
// ❌ خطأ - كشف تفاصيل داخلية
app.get('/users/:id', async (req, res) => {
  try {
    const user = await getUser(req.params.id);
    res.json(user);
  } catch (error) {
    res.status(500).json({ 
      error: error.message,  // قد يكشف معلومات حساسة!
      stack: error.stack     // خطير جداً!
    });
  }
});

// ✅ صحيح - إخفاء التفاصيل
app.get('/users/:id', async (req, res) => {
  try {
    const user = await getUser(req.params.id);
    res.json(user);
  } catch (error) {
    // تسجيل الخطأ الكامل للمطور
    logger.error('Failed to get user', {
      userId: req.params.id,
      error: error.message,
      stack: error.stack
    });
    
    // رسالة ودية للمستخدم
    res.status(500).json({ 
      error: 'حدث خطأ أثناء جلب البيانات. يرجى المحاولة لاحقاً.',
      errorCode: 'USER_FETCH_ERROR',
      requestId: req.id  // للدعم الفني
    });
  }
});
```

**العقوبة:** رفض الدمج - أي كشف لـ stack trace أو تفاصيل داخلية يُرفض.

---

## القاعدة 27: حماية الـ API (API Security Rule)

> **جميع نقاط الـ API يجب أن تكون محمية بالمصادقة والتفويض المناسب.**

**طبقات الحماية:**

```
┌─────────────────────────────────────────────────────────────┐
│                    طلب من المستخدم                          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  1. Rate Limiting     - تحديد عدد الطلبات                  │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  2. Authentication    - التحقق من الهوية (JWT)             │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  3. Authorization     - التحقق من الصلاحيات                │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  4. Input Validation  - التحقق من المدخلات                 │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  5. Business Logic    - تنفيذ العملية                      │
└─────────────────────────────────────────────────────────────┘
```

**مثال على الحماية الكاملة:**
```typescript
router.delete('/users/:id',
  rateLimit({ max: 10, windowMs: 60000 }),  // 1. Rate Limiting
  authenticate,                               // 2. Authentication
  authorize(['admin']),                       // 3. Authorization
  validateParams(deleteUserSchema),           // 4. Validation
  async (req, res) => {                       // 5. Business Logic
    await deleteUser(req.params.id);
    res.json({ success: true });
  }
);
```

**العقوبة:** رفض الدمج - أي endpoint بدون حماية كاملة يُرفض.

---

## ملخص قواعد الأمان المتقدم

| # | القاعدة | العقوبة |
|:---:|:---|:---:|
| 24 | التحقق من المدخلات (Zod Validation) | رفض |
| 25 | سجلات التدقيق (Audit Logs) | رفض |
| 26 | عدم كشف الأخطاء الداخلية | رفض |
| 27 | حماية الـ API الكاملة | رفض |
