# ุชูุฑูุฑ ูุดุงูู ุงููุธุงู ุงููุฎุตุต - Custom System Issues Report
## ๐ ุงูุชุงุฑูุฎ: 2 ููุงูุฑ 2026

---

## ๐ ููุฎุต ุงููุญุต

### โ ุญุงูุฉ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- **DATABASE_URL**: โ ูุญุฏุฏ ููุชุตู
- **ุงููุถูู**: localhost:3306
- **ูุงุนุฏุฉ ุงูุจูุงูุงุช**: 666666
- **ุงูุญุงูุฉ**: โ ูุชุตู ุจูุฌุงุญ ูุน UTF-8 encoding
- **ุฅุฌูุงูู ุงูุฌุฏุงูู**: 148 ุฌุฏูู
- **ุงูุฌุฏุงูู ุงููุฎุตุตุฉ**: 24 ุฌุฏูู

---

## โ ุงููุดุงูู ุงูููุชุดูุฉ

### 1. ุฌุฏุงูู ููููุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (Missing Tables)

#### ๐ด **ุฎุทูุฑุฉ ุนุงููุฉ**: `custom_transactions`
- **ุงููุดููุฉ**: ุงูุฌุฏูู ูุนุฑูู ูู Schema ูููู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **ุงููููุน**: `drizzle/schema.ts:1685`
- **ุงููุณุชุฎุฏู ูู**: `server/customSystemRouter.ts` - customTransactionsRouter
- **ุงูุฃุซุฑ**: ุณููุดู ุฃู ุงุณุชุนูุงู ูุญุงูู ุงููุตูู ุฅูู ุฌุฏูู custom_transactions
- **ุงูุญู ุงูููุชุฑุญ**:
  ```bash
  pnpm drizzle-kit push
  ```

#### ๐ด **ุฎุทูุฑุฉ ุนุงููุฉ**: `custom_treasury_movements`
- **ุงููุดููุฉ**: ุงูุฌุฏูู ูุนุฑูู ูู Schema ูููู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **ุงููููุน**: `drizzle/schema.ts:3472`
- **ุงููุณุชุฎุฏู ูู**: `server/customSystemRouter.ts` - customTreasuryRouter
- **ุงูุฃุซุฑ**: ุณููุดู ุฃู ุงุณุชุนูุงู ูุญุงูู ุงููุตูู ุฅูู ุญุฑูุงุช ุงูุฎุฒููุฉ
- **ุงูุญู ุงูููุชุฑุญ**:
  ```bash
  pnpm drizzle-kit push
  ```

---

### 2. ูุดุงูู ูู ุงูููุฏ (Code Issues)

#### ๐ **ุฎุทูุฑุฉ ูุชูุณุทุฉ**: ุงูุชุญูู ุงูููุฑุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **ุงููููุน**: `server/customSystemRouter.ts` - ุนุฏุฉ ููุงูุน (14 ููุถุน)
- **ุงููุดููุฉ**: ููุฌุฏ ููุฏ ุชุญูู ููุฑุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
  ```typescript
  const db = await getDb();
  if (!db) throw new Error("Database not available");  // ุงูุณุทุฑ ุงูุฃูู
  if (!db) return [];  // ุงูุณุทุฑ ุงูุซุงูู - ูู ูุชู ุชูููุฐู ุฃุจุฏุงู (dead code)
  ```
- **ุงูุฃุซุฑ**: 
  - ููุฏ ุบูุฑ ุถุฑูุฑู (dead code)
  - ุฅุฑุจุงู ูููุทูุฑูู
  - ูุฏ ูุณุจุจ ูุดุงูู ุตูุงูุฉ
- **ุงูููุงูุน ุงููุชุฃุซุฑุฉ**:
  1. Line 56-57 (customAccounts.list)
  2. Line 91-92 (customAccounts.getById)
  3. Line 141-142 (customAccounts.create)
  4. Line 178-179 (customAccounts.update)
  5. Line 201-202 (customAccounts.delete)
  6. Line 239-240 (customTransactions.list)
  7. ูุงููุฒูุฏ...
  
- **ุงูุญู ุงูููุชุฑุญ**: ุชูุญูุฏ ุงูุชุญูู ูุงูุงุญุชูุงุธ ุจุทุฑููุฉ ูุงุญุฏุฉ ููุท

---

### 3. ูููุฏ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ ุงูููููุฏุฉ (Missing Foreign Keys)

#### ๐ก **ุฎุทูุฑุฉ ููุฎูุถุฉ**: `custom_treasury_currencies`
- **ุงููุดููุฉ**: ูุง ุชูุฌุฏ Foreign Keys ูุญุฏุฏุฉ ูู ุงูุฌุฏูู
- **ุงููุชููุน ูู SQL**: 
  ```sql
  FOREIGN KEY (`treasury_id`) REFERENCES `custom_treasuries`(`id`) ON DELETE CASCADE
  FOREIGN KEY (`currency_id`) REFERENCES `custom_currencies`(`id`) ON DELETE RESTRICT
  FOREIGN KEY (`business_id`) REFERENCES `businesses`(`id`) ON DELETE CASCADE
  ```
- **ุงูุญุงูุฉ ุงูุญุงููุฉ**: ุงูุฌุฏูู ููุฌูุฏ ูููู ุจุฏูู ูููุฏ ูุฑุฌุนูุฉ
- **ุงูุฃุซุฑ**: 
  - ุนุฏู ุงูุญูุงุธ ุนูู integrit ุงูุจูุงูุงุช ุชููุงุฆูุงู
  - ุฅููุงููุฉ ูุฌูุฏ ุจูุงูุงุช ูุชููุฉ (orphaned data)
  - ูุง ููุฌุฏ cascade delete ุชููุงุฆู
- **ุงูุญู ุงูููุชุฑุญ**: ุงูุชุญูู ูู ููู `create-treasuries-table.sql` ูุชุทุจูู Foreign Keys

---

## ๐ ุฅุญุตุงุฆูุงุช ุงูุจูุงูุงุช

### ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ ูุงูุจูุงูุงุช:

| ุงูุฌุฏูู | ุนุฏุฏ ุงูุณุฌูุงุช | ุงูุญุงูุฉ |
|-------|------------|--------|
| `custom_account_balances` | 0 | โ ูุงุฑุบ |
| `custom_account_currencies` | 3 | โ ูุญุชูู ุจูุงูุงุช |
| `custom_account_sub_types` | 4 | โ ูุญุชูู ุจูุงูุงุช |
| `custom_account_types` | 11 | โ ูุญุชูู ุจูุงูุงุช |
| `custom_accounts` | 14 | โ ูุญุชูู ุจูุงูุงุช |
| `custom_categories` | 0 | โ ูุงุฑุบ |
| `custom_currencies` | 3 | โ ูุญุชูู ุจูุงูุงุช |
| `custom_exchange_rates` | 0 | โ ูุงุฑุบ |
| `custom_intermediary_accounts` | 0 | โ ูุงุฑุบ |
| `custom_journal_entries` | 0 | โ ูุงุฑุบ |

---

## ๐ง ุงูุญููู ุงูููุตู ุจูุง

### 1. ุชุดุบูู Migrations

```bash
# ูู ูุฌูุฏ ุงููุดุฑูุน
cd f:\666666\6666-main

# ุชุดุบูู migrations ูุฅูุดุงุก ุงูุฌุฏุงูู ุงูููููุฏุฉ
pnpm drizzle-kit push

# ุงูุชุญูู ูู ุงููุชูุฌุฉ
pnpm tsx check-custom-system.ts
```

### 2. ุฅุตูุงุญ ูุดููุฉ ุงูุชุญูู ุงูููุฑุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

ูุฌุจ ุชูุญูุฏ ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู `customSystemRouter.ts`:

**ุงูุทุฑููุฉ ุงูุญุงููุฉ (ุงููุดููุฉ):**
```typescript
const db = await getDb();
if (!db) throw new Error("Database not available");
if (!db) return [];  // dead code
```

**ุงูุทุฑููุฉ ุงูููุตู ุจูุง:**
```typescript
const db = await getDb();
if (!db) throw new TRPCError({ 
  code: 'INTERNAL_SERVER_ERROR', 
  message: 'Database not available' 
});
```

### 3. ุฅุถุงูุฉ Foreign Keys

```sql
-- ุฅุถุงูุฉ Foreign Keys ูุฌุฏูู custom_treasury_currencies
ALTER TABLE custom_treasury_currencies
  ADD CONSTRAINT fk_ctc_treasury 
    FOREIGN KEY (treasury_id) REFERENCES custom_treasuries(id) ON DELETE CASCADE,
  ADD CONSTRAINT fk_ctc_currency 
    FOREIGN KEY (currency_id) REFERENCES custom_currencies(id) ON DELETE RESTRICT,
  ADD CONSTRAINT fk_ctc_business 
    FOREIGN KEY (business_id) REFERENCES businesses(id) ON DELETE CASCADE;
```

---

## โ๏ธ ุงููุฎุงุทุฑ ุงูุญุงููุฉ

### ูุฎุงุทุฑ ุนุงููุฉ:
1. **ูุดู ุงูู API Calls** ุนูุฏ ูุญุงููุฉ ุงููุตูู ูุฌุฏุงูู ููููุฏุฉ
2. **Crashes ูุญุชููุฉ** ูู runtime ุนูุฏ ุงุณุชุฎุฏุงู custom_transactions ุฃู custom_treasury_movements

### ูุฎุงุทุฑ ูุชูุณุทุฉ:
1. **ุตุนูุจุฉ ุงูุตูุงูุฉ** ุจุณุจุจ ุงูููุฏ ุงูููุฑุฑ
2. **ุฅุฑุจุงู ุงููุทูุฑูู** ุจุณุจุจ ุงูุชุญููุงุช ุงููุฒุฏูุฌุฉ

### ูุฎุงุทุฑ ููุฎูุถุฉ:
1. **Data Integrity** ูุฏ ุชุชุฃุซุฑ ุจุณุจุจ ุนุฏู ูุฌูุฏ Foreign Keys
2. **Orphaned Data** ูุญุชูู ูู ุงููุณุชูุจู

---

## โ ุงูููุงุท ุงูุฅูุฌุงุจูุฉ

1. โ ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนูู ุจุดูู ููุชุงุฒ
2. โ UTF-8 encoding ูุถุจูุท ุจุดูู ุตุญูุญ ูููุตูุต ุงูุนุฑุจูุฉ
3. โ ูุนุธู ุงูุฌุฏุงูู ุงููุฎุตุตุฉ ููุฌูุฏุฉ (24 ุฌุฏูู)
4. โ ููุฌุฏ ุจูุงูุงุช ุฃูููุฉ ูู ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ
5. โ ุงูู Schema ููุธู ุฌูุฏุงู ู documented

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ ุงูููุชุฑุญุฉ

### ุงูุฃููููุฉ ุงูุนุงููุฉ (ูุฌุจ ุงูุชูููุฐ ููุฑุงู):
1. โ ุชุดุบูู `pnpm drizzle-kit push` ูุฅูุดุงุก ุงูุฌุฏุงูู ุงูููููุฏุฉ
2. โ ุงุฎุชุจุงุฑ ุงูู API endpoints ุงููุชุนููุฉ ุจุงูุญุฑูุงุช ูุงูุฎุฒุงุฆู

### ุงูุฃููููุฉ ุงููุชูุณุทุฉ (ุฎูุงู ุฃุณุจูุน):
3. ๐ง ุฅุตูุงุญ ูุดููุฉ ุงูููุฏ ุงูููุฑุฑ ูู customSystemRouter.ts
4. ๐ง ุฅุถุงูุฉ Foreign Keys ููุฌุฏุงูู ุงููุทููุจุฉ
5. ๐งช ุฅุถุงูุฉ Unit Tests ููู custom system routers

### ุงูุฃููููุฉ ุงูููุฎูุถุฉ (ูููู ุชุฃุฌูููุง):
6. ๐ ุชุญุฏูุซ ุงูุชูุซูู
7. ๐ Code review ุดุงูู ูููุธุงู ุงููุฎุตุต
8. ๐จ ุชุญุณููุงุช ุนูู ุงูุฃุฏุงุก ูุงูุฃูุงู

---

## ๐ ููุงุณุชูุณุงุฑุงุช
- ุฑุงุฌุน ุงููููุงุช ุงููุฑููุฉ: `check-custom-system.ts` ู `check-db-status.ts`
- ุดุบูู `pnpm tsx check-custom-system.ts` ููุญุตูู ุนูู ุชูุฑูุฑ ูุญุฏุซ

---

**ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ ุจูุงุณุทุฉ**: ูุญุต ุขูู ูููุธุงู  
**ุขุฎุฑ ุชุญุฏูุซ**: 2 ููุงูุฑ 2026

